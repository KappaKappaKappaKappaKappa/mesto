(()=>{"use strict";class e{constructor(e,t,s,r,n){this._cardTemplate=t,this._handleOpenImage=s,this._openDeletePopup=r,this._cardData=e,this._link=this._cardData.link,this._name=this._cardData.name,this._myId=this._cardData.myid,this._ownerId=this._cardData.owner._id,this._likes=this._cardData.likes,this._likeLength=this._cardData.likes.length,this._changeLike=n,this._cardId=e._id,this._cardElement=this._cardTemplate.content.querySelector(".cards__list-card").cloneNode(!0),this._cardLikeNumbers=this._cardElement.querySelector(".card__like-numbers"),this._cardImage=this._cardElement.querySelector(".card__image"),this._cardPlace=this._cardElement.querySelector(".card__place"),this._cardDelBtn=this._cardElement.querySelector(".card__trash"),this._cardLikeBtn=this._cardElement.querySelector(".card__like")}_cardDelete(){this._openDeletePopup({card:this,cardId:this._cardId})}_cardLike(){this._changeLike(this._cardLikeBtn,this._cardId)}toggleLike(e){this._cardLikeBtn.classList.toggle("card__like_active"),this._cardLikeNumbers.textContent=e.length}_checkLikeStatus(){this._likes.forEach((e=>{e._id!==this._myId||this._cardLikeBtn.classList.toggle("card__like_active")})),this._cardLikeNumbers.textContent=this._likeLength}_changeVisibleForTrashBtn(){this._myId===this._ownerId?this._cardDelBtn.style.display="block":this._cardDelBtn.style.display="none"}_setEventListeners(){this._cardDelBtn.addEventListener("click",this._cardDelete.bind(this)),this._cardLikeBtn.addEventListener("click",(()=>{this._cardLike()})),this._cardImage.addEventListener("click",(()=>{this._handleOpenImage(this._cardData)}))}createCardElement(){return this._cardImage.src=this._link,this._cardImage.alt=this._name,this._cardPlace.textContent=this._name,this._checkLikeStatus(),this._changeVisibleForTrashBtn(),this._setEventListeners(),this._cardElement}removeCard(){this._cardElement.remove()}}class t{constructor(e,t){this._settings=e,this._formEl=t,this._inputList=Array.from(this._formEl.querySelectorAll(this._settings.inputSelector)),this._buttonEl=this._formEl.querySelector(this._settings.buttonSelector)}_checkValid(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_showInputError(e,t){const s=this._formEl.querySelector(`.pop-up__form-${e.id}-error`);e.classList.add(this._settings.inputErrorClass),s.textContent=t}_hideInputError(e){const t=this._formEl.querySelector(`.pop-up__form-${e.id}-error`);e.classList.remove(this._settings.inputErrorClass),t.textContent=""}_setEventListeners(){this._toggleButtonSaveState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkValid(e),this._toggleButtonSaveState()}))}))}_disableBtnSave(){this._buttonEl.classList.add(this._settings.inactiveButtonClass),this._buttonEl.setAttribute("disabled","")}_removeDisableBtnSave(){this._buttonEl.classList.remove(this._settings.inactiveButtonClass),this._buttonEl.removeAttribute("disabled")}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonSaveState(){this._hasInvalidInput()?this._disableBtnSave():this._removeDisableBtnSave()}clearInputErrors(){this._inputList.forEach((e=>{this._hideInputError(e)}))}enableValidation(){this._formEl.addEventListener("reset",(()=>{this._disableBtnSave()})),this._setEventListeners()}}const s={formSelector:".pop-up__form",inputSelector:".pop-up__form-input",buttonSelector:".pop-up__form-button-save",inactiveButtonClass:"pop-up__form-button-save_inactive",inputErrorClass:"pop-up__form-input_type_error"},r=document.querySelector(".profile-info__edit-button"),n=document.querySelector(".profile__add-button"),i=".pop-up_show_edit-profile",o=document.querySelector(".card-template"),a=document.querySelector(".pop-up_show_edit-profile").querySelector(".pop-up__form"),c=document.querySelector(".pop-up_show_add-cards").querySelector(".pop-up__form"),_=document.querySelector(".pop-up_show_delete-submit").querySelector(".pop-up__form"),h=document.querySelector(".pop-up_show_new-avatar-form").querySelector(".pop-up__form"),l=(document.querySelector(".profile__avatar"),document.querySelector(".profile__avatar-btn"));class d{constructor(e){this._popup=document.querySelector(e),this._popupButtonClose=this._popup.querySelector(".pop-up__button-close"),this._form=this._popup.querySelector(".pop-up__form")}_handleCloseEscPopup=e=>{"Escape"===e.key&&this.close()};_handleButtonClose=()=>{this.close()};_handleClickOverlay=e=>{e.target===e.currentTarget&&this.close()};setEventListeners(){this._popupButtonClose.addEventListener("click",this._handleButtonClose),this._popup.addEventListener("click",this._handleClickOverlay)}open(){this._popup.classList.add("pop-up_opened"),document.addEventListener("keydown",this._handleCloseEscPopup)}close(){this._popup.classList.remove("pop-up_opened"),document.removeEventListener("keydown",this._handleCloseEscPopup)}}class p extends d{constructor(e,t){super(e),this._submitFunction=t,this._form=this._popup.querySelector(".pop-up__form"),this._inputList=this._form.querySelectorAll(".pop-up__form-input"),this._saveBtn=this._form.querySelector(".pop-up__form-button-save"),this._saveBtnDefaultText=this._saveBtn.textContent}_getInputValues(){const e={};return this._inputList.forEach((t=>{e[t.name]=t.value})),e}_renderLoading(){this._saveBtn.textContent=`${this._saveBtn.textContent}...`}setInputValues(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._renderLoading(),this._submitFunction(this._getInputValues())}))}setupDefaultText(){this._saveBtn.textContent=this._saveBtnDefaultText}close(){super.close(),this._form.reset()}}const u=new class{constructor(e){this._profileName=document.querySelector(e.profileNameSelector),this._profileProfession=document.querySelector(e.profileProfessionSelector),this._profileAvatar=document.querySelector(e.profileAvatar)}getUserInfo(){return{username:this._profileName.textContent,profession:this._profileProfession.textContent}}setUserInfo({username:e,profession:t,avatar:s,_id:r}){this._profileAvatar.src=s,this._profileName.textContent=e,this._profileProfession.textContent=t}}({profileNameSelector:".profile-info__name",profileProfessionSelector:".profile-info__profession",profileAvatar:".profile__avatar"}),m=new class extends d{constructor(e){super(e),this._popupImage=this._popup.querySelector(".pop-up__image"),this._popupImageName=this._popup.querySelector(".pop-up__card-name")}open=e=>{super.open(),this._popupImage.src=e.link,this._popupImage.alt=e.name,this._popupImageName.textContent=e.name}}(".pop-up_show_zoom-card");m.setEventListeners();const f=new p(i,(e=>{b.setUserInfo(e).then((e=>{u.setUserInfo({username:e.name,profession:e.about,avatar:e.avatar}),f.close()})).catch((e=>console.error(`Ошибка редактирования профиля${e}`))).finally((()=>f.setupDefaultText()))}));f.setEventListeners();const v=new p(".pop-up_show_new-avatar-form",(e=>{b.setNewAvatar(e).then((e=>{u.setUserInfo({username:e.name,profession:e.about,avatar:e.avatar}),v.close()})).catch((e=>console.error(`Ошибка при обновлении аватара ${e}`))).finally((()=>v.setupDefaultText()))}));v.setEventListeners();const E=new d(i);E.setEventListeners();const k=new class extends d{constructor(e,t){super(e),this._submitFunction=t,this._form=this._popup.querySelector(".pop-up__form"),this._saveBtn=this._form.querySelector(".pop-up__form-button-save"),this._saveBtnDefaultText=this._saveBtn.textContent}_renderLoading(){this._saveBtn.textContent=`${this._saveBtn.textContent}...`}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._renderLoading(),this._submitFunction({card:this._element,cardId:this._cardId})}))}setupDefaultText(){this._saveBtn.textContent=this._saveBtnDefaultText}open=({card:e,cardId:t})=>{super.open(),this._element=e,this._cardId=t};close(){super.close()}}(".pop-up_show_delete-submit",(({card:e,cardId:t})=>{b.deleteCard(t).then((()=>{e.removeCard(),k.close()})).catch((e=>console.error(`Ошибка при удалении каточки ${e}`))).finally((()=>k.setupDefaultText()))}));function L(t){const s=new e(t,o,m.open,k.open,((e,t)=>{e.classList.contains("card__like_active")?b.deleteLike(t).then((e=>{s.toggleLike(e.likes)})).catch((e=>console.error(`Ошибка при удалении лайка ${e}`))):b.addLike(t).then((e=>{s.toggleLike(e.likes)})).catch((e=>console.error(`Ошибка при добавлении лайка ${e}`)))}));return s.createCardElement()}k.setEventListeners();const y=new class{constructor(e,t){this._container=document.querySelector(t),this._renderer=e}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItemPrepend(e){this._container.prepend(e)}addItemAppend(e){this._container.append(e)}}((e=>{y.addItemPrepend(L(e))}),".cards__list");r.addEventListener("click",(()=>{S.clearInputErrors(),f.setInputValues(u.getUserInfo()),E.open()})),n.addEventListener("click",(()=>{C.open(),g.clearInputErrors()}));const S=new t(s,a);S.enableValidation();const g=new t(s,c);g.enableValidation(),new t(s,_).enableValidation();const I=new t(s,h);I.enableValidation(),l.addEventListener("click",(()=>{I.clearInputErrors(),v.open()}));const b=new class{constructor(e){this._url=e.baseUrl,this._headers=e.headers,this._token=e.headers.authorization}_checkAnswer(e){return e.ok?e.json():Promise.reject}getInfo(){return fetch(`${this._url}/users/me`,{headers:{authorization:this._token}}).then(this._checkAnswer)}getCards(){return fetch(`${this._url}/cards`,{headers:{authorization:this._token}}).then(this._checkAnswer)}setUserInfo(e){return fetch(`${this._url}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.username,about:e.profession})}).then(this._checkAnswer)}setNewAvatar(e){return fetch(`${this._url}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})}).then(this._checkAnswer)}addCard(e){return fetch(`${this._url}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.title,link:e.link})}).then(this._checkAnswer)}addLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"PUT",headers:{authorization:this._token}}).then(this._checkAnswer)}deleteLike(e){return fetch(`${this._url}/cards/${e}/likes`,{method:"DELETE",headers:{authorization:this._token}}).then(this._checkAnswer)}deleteCard(e){return fetch(`${this._url}/cards/${e}`,{method:"DELETE",headers:{authorization:this._token}}).then(this._checkAnswer)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-69",headers:{authorization:"a069766e-f2cf-4169-8365-de2d06b0c981","Content-Type":"application/json"}}),C=new p(".pop-up_show_add-cards",(e=>{b.addCard(e).then((e=>{e.myid=e.owner._id,y.addItemPrepend(L(e)),C.close()})).catch((e=>console.error(`Ошибка при добавлении новой карточки ${e}`))).finally((()=>C.setupDefaultText()))}));C.setEventListeners(),Promise.all([b.getInfo(),b.getCards()]).then((([e,t])=>{t.forEach((t=>t.myid=e._id)),u.setUserInfo({username:e.name,profession:e.about,avatar:e.avatar}),y.renderItems(t.reverse())})).catch((e=>console.error(`Ошибка при начальной загрузке данных страницы${e}`)))})();